<!--
(C) Copyright 2015â€“2022 Potsdam Institute for Climate Impact Research (PIK), authors, and contributors, see AUTHORS file.

This file is part of vodle.

vodle is free software: you can redistribute it and/or modify it under the 
terms of the GNU Affero General Public License as published by the Free 
Software Foundation, either version 3 of the License, or (at your option) 
any later version.

vodle is distributed in the hope that it will be useful, but WITHOUT ANY 
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR 
A PARTICULAR PURPOSE. See the GNU Affero General Public License for more 
details.

You should have received a copy of the GNU Affero General Public License 
along with vodle. If not, see <https://www.gnu.org/licenses/>. 
-->

<!--
  TODO: 
  - "fix" slider element's absolute vertical position on screen while using it, even when note above it changes height. achieve this by automatically "scrolling" to compensate such layout changes.  
-->

<!--
Suggestion

vodle suggests that you look for a possible compromise between
Y
and Z.

Why?

Y currently gets the share of A% of the participants, including yours.
Either: You don't approve Z, but it gets the share of B% of the participants.
Or: The share of another B% goes to Z.
Together, you might be able to agree on a better compromise with all these participants.

How?

Try to find some other option X that appeals to both groups.
Maybe this option is already on the list, or you might have to add it.
Then suggest that all participants whose share now goes to Y or Z 
consider giving option X a wap of more than 100-C.
If they all do so, then they all approve X.
The share of all these participants will then move to X.
You yourself would have to give X a wap of more than 100-C as well, of course. 
Your share will then also move to X, 
but only if the others approve X as well.

Instead of having A% Y plus B% Z, you would then have C% X (or more, if even more approve X).

[Diagram: Pie A + Pie B -> Pie C for some other option X?]

-->

<!-- HEADER: -->

<ion-header 
    (pointerup)="onBodyPointerup($event)"
    (touchup)="onBodyTouchup($event)">
  <ion-toolbar style="padding-right: 11px; padding-left: 16px;">
    <ion-buttons slot="start" style="margin-right: 0px; margin-left: 0px; padding-left: 0px; padding-right: 0px;">
      <ion-menu-button style="padding-left: 0px!important; padding-right: 0px!important; position: relative; left: -9px;"></ion-menu-button>
    </ion-buttons>
    <ion-text *ngIf="scroll_position < 70" 
      style="font-weight: bold; font-size: larger; padding-left: 0px;"
      [innerHtml]="'poll.-page-title' | translate">
    </ion-text>
    <ion-text *ngIf="scroll_position >= 70"><b><i [lang]="p.language" [innerHtml]="p.title"></i></b></ion-text>
    <ion-buttons slot="end">

      <!-- OFFLINE SIGN -->
      <ng-container *ngIf="!window.navigator.onLine">
        <ion-icon name="cloud-offline-outline" color="grey"
          style="position: relative; bottom: -1px;">
        </ion-icon>
        <ion-icon name="alert-outline" color="grey">
        </ion-icon>
      </ng-container> 

      <!-- SYNCING SIGN -->
      <ion-spinner *ngIf="!!p && p.syncing && window.navigator.onLine" name="crescent" color="grey"></ion-spinner>

      <!-- TRANSMITTED SIGN -->
      <ion-button *ngIf="!!p && p.have_acted && !p.syncing && window.navigator.onLine" class="ion-no-margin ion-no-padding" fill="clear" (click)="checkmark_clicked()">
        <ion-icon size="large" name="checkmark" color="grey" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- DELEGATE BUTTON: -->
      <ion-button *ngIf="!!p && delegation_status!='agreed' && p.allow_voting"
          (click)="delegate_dialog($event)" 
          shape="round" size="large" color="primary" class="ion-no-padding ion-no-margin">
        <span *ngIf="scroll_position < 70"
          [innerHtml]="'poll.delegate-button' | translate">
        </span><ion-button class="ion-no-margin ion-no-padding"
            [disabled]="!E.delegation.enabled"
            style="position: relative; right: -4px;"
            shape="round" fill="solid" color="primary">
          <ion-icon class="ion-no-margin ion-no-padding" src="./assets/icon/delegate-simple.svg">
          </ion-icon>
        </ion-button>
      </ion-button>

    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- SCROLLABLE CONTENT: -->

<ion-content *ngIf="ready && !!p" 
    (pointerup)="onBodyPointerup($event)"
    (touchup)="onBodyTouchup($event)"
    [scrollEvents]="true"
    (ionScroll)="onScroll($event)"    
    >
  <ion-list lines="full" class="ion-no-margin ion-no-padding">

    <!-- NEWS -->

    <ion-card *ngFor="let n of news">
      <ion-card-content class="ion-no-margin ion-no-padding">
        <ion-item lines="none" class="ion-no-margin ion-no-padding item-text-wrap" color="warning">
          &nbsp;&nbsp;
          <ion-label class="ion-no-margin ion-no-padding">
            {{n.title}}
            <small *ngIf="n.body">
              <br/>
              {{n.body}}
            </small>  
          </ion-label>
          <ion-button slot="end" class="ion-no-margin ion-no-padding" fill="clear" size="small" (click)="news.delete(n);G.N.dismiss(n.key)">
            <ion-icon slot="icon-only" name="close-outline" style="color:gray!important">
            </ion-icon>    
          </ion-button>  
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- GENERAL POLL INFORMATION -->

    <ion-item color="primary" class="ion-no-margin" lines="none">
      <ion-grid class="ion-no-padding ion-no-margin">
        <ion-row class="ion-no-padding ion-no-margin">
          <ion-col class="ion-no-padding ion-no-margin">

            <!-- NOTIFY OF DIFFERENT LANGUAGE: -->

            <small *ngIf="(!!p.language) && (p.language != G.S.language)">
              <p [innerHtml]="'poll.different-language' | translate: {language: G.S.language_names[p.language]}"></p>
            </small>

            <!-- POLL TITLE -->

            <h3><b><i [lang]="p.language" [innerHtml]="p.title"></i></b></h3>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-item>
    <ion-item *ngIf="(p.desc||'')!='' || (p.url||'') != ''"
        color="primary" class="ion-padding-left ion-padding-right" 
        style="cursor: pointer; --min-height: 0!important;"
        (click)="details_expanded =! details_expanded">
      <ion-grid class="ion-no-padding ion-padding-bottom ion-no-margin" style="width: 100%;">
        <ion-row class="ion-no-padding ion-no-margin">
          <ion-col class="ion-no-padding ion-no-margin">

            <!-- POLL DESCRIPTION, "READ MORE" LINK -->

            <div [style]="
                details_expanded
                ? 'white-space: normal; overflow: hidden; text-overflow: ellipsis; width: 100%!important;'
                : 'white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%!important;'
                ">
              <i *ngIf="(p.desc||'')!=''" [lang]="p.language" [innerHtml]="p.desc"></i><span *ngIf="(p.desc||'')!='' && (p.url||'') != ''">&nbsp;</span>
              <small *ngIf="(p.url||'') != ''">
                (<span (click)="G.open_url_in_new_tab(G.D.fix_url(p.url));details_expanded=!details_expanded"><ion-text 
                  class="externallink"  
                  [innerHtml]="'read-more' | translate">
                </ion-text>&nbsp;<ion-icon name="open-outline" style="position: relative; top: 2px;"></ion-icon></span>)
              </small>
              <small *ngIf="details_expanded">
                &nbsp;
                (<ion-text 
                  class="externallink" 
                  [innerHtml]="'hide' | translate">
                </ion-text>)
              </small>
            </div>

          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-item>
    <ion-item color="primary" class="ion-no-margin ion-padding-left ion-padding-right" >
      <ion-grid class="ion-no-padding ion-no-margin">
        <ion-row class="ion-no-padding ion-no-margin">
          <ion-col class="ion-no-padding ion-no-margin" style="padding-bottom:8px; padding-top:2px;">

            <!-- ASSIST BUTTON: -->

            <ion-button *ngIf="p.allow_voting"
                (click)="assist_dialog()" 
                size="small" fill="clear" class="ion-float-right ion-no-padding ion-no-margin"
                style="position: relative; top: 5px; right: 10px; margin-left:20px; margin-bottom:5px!important;">
              <ion-label *ngIf="details_expanded" style="color:#88e950; white-space: normal; text-align: right; font-size: 11.5px;"
                [innerHtml]="'poll.assist-me-button' | translate">
              </ion-label>&nbsp;<ion-button shape="round" class="ion-no-padding ion-no-margin" color="success">
                <ion-icon name="color-wand-outline" slot="icon-only" 
                  style="margin: 5px;"></ion-icon>
              </ion-button>
            </ion-button>

            <!-- CLOSING DATE, CLOSING SOON BADGE: -->

            <small>
              <span style="white-space: nowrap;">
                <ion-badge *ngIf="p.allow_voting && p.is_closing_soon" 
                  class="ion-no-margin" 
                  style="position: relative; bottom: -5.5px; font-size: 11.5px;" 
                  color="danger" 
                  [innerHtml]="'badges.closing-soon'|translate">
                </ion-badge>
                <span *ngIf="p.allow_voting && !p.is_closing_soon"
                  [innerHtml]="'poll.closes' | translate">
                </span><span *ngIf="!p.allow_voting"
                  [innerHtml]="'poll.closed' | translate">
                </span>&nbsp;<b 
                  [innerHtml]="G.D.format_date(p.due)">
                </b>
              </span><br/>
              <span style="white-space: nowrap;">
                <ion-icon color="light" style="position: relative; top: 2px" [name]="(p.type=='share')?'cut-outline':'trophy-outline'"></ion-icon>&nbsp;<span [innerHtml]="((p.type=='share')?'poll.type-share':'poll.type-winner')|translate"></span>
              </span>
            </small>
            <br/>

            <!-- STATISTICS: -->

            <small style="white-space: nowrap;">
              <span style="white-space: nowrap;">
                <ion-icon 
                    color="light" style="position: relative; top: 2px" 
                    name="people-outline">
                </ion-icon>&nbsp;<b>{{p.T.n_not_abstaining}}</b>&nbsp;<span class="externallink" (click)="glossary('non-abstaining')" [innerHtml]="'non-abstaining-voters'|translate"></span>&nbsp;&nbsp;&nbsp;
  <!--              <ion-button
                    class="ion-no-padding ion-no-margin" fill="clear" size="small" 
                    [routerLink]="'/inviteto/'+p.pid" >
                  <ion-icon 
                      class="ion-no-padding ion-no-margin" 
                      style="font-size: 14px; position: relative; top: -1px"
                      name="share-social-outline" 
                      color="light">
                  </ion-icon>
                </ion-button>&nbsp;<span class="externallink" [routerLink]="'/inviteto/'+p.pid">Mehr einladen</span>-->
                <br/>
              </span>
            </small>
            <small style="white-space: nowrap;">
              <span style="white-space: nowrap;">
                <ion-icon 
                    color="light" style="position: relative; top: 2px;" 
                    [name]="p.agreement_level == 1 ? 'checkmark-done-outline' : 'analytics-outline'">
                </ion-icon><b>&nbsp;{{(p.agreement_level * 100).toFixed(1)}}</b><span 
                    class="externallink" 
                    (click)="glossary('level-of-agreement')" 
                    [innerHtml]="'poll.level-of-agreement'|translate"
                  ></span><ng-container *ngIf="p.T.n_not_abstaining > 0">&nbsp;(<span 
                  class="externallink" 
                  (click)="analysis_dialog()" 
                  [innerHtml]="'poll.analysis-details'|translate"
                ></span>)</ng-container>
              </span>&nbsp;

              <!-- SUGGESTIONS BUTTON (TODO: place somewhere else): -->

              <ion-badge *ngIf="false"
                    class="ion-no-margin" 
                    style="position: relative; bottom:-6px; font-size: 11.5px; padding-top:2px" 
                    color="success" 
                    (click)="analysis_dialog()"
                    >
                <ion-icon name="bulb-outline" class="ion-no-padding ion-no-margin"
                  style="position: relative; top: 1.5px;"></ion-icon>&nbsp;<span [innerHtml]="'suggestions'"></span> 
              </ion-badge>

              <!-- LIVE SCORES TOGGLE: -->

              <ion-button [disabled]="!p.allow_voting"
                  (click)="toggle_show_live()" 
                  size="small" fill="clear" class="ion-no-padding ion-no-margin"
                  style="position: absolute; right:8.5px; bottom:8px;" 
                  >
                <ng-container *ngIf="p.allow_voting">
                  <span style="color:#88e950; white-space: normal; text-align: right; font-size: 11.5px;"
                    [innerHtml]="'poll.show-live' | translate">
                  </span>&nbsp;<ion-button size="small" shape="round" color="success" class="ion-no-border ion-no-padding"><ion-icon slot="icon-only" [name]="show_live?'eye-off-outline':'eye-outline'" style="padding-left:4px;padding-right:5px"></ion-icon></ion-button><!--<ion-toggle [checked]="show_live" color="warning" style="padding-left: 0px!important;"></ion-toggle>-->
                </ng-container>
              </ion-button>

            </small>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-item>

    <!-- VOTE STATUS BANNER: -->

    <ng-container *ngIf="p.allow_voting">
      <ion-item *ngIf="!p.have_acted && !p.am_abstaining" color="warning">
        <small>
          <p>
            <span style="font-size: medium" [innerHtml]="'poll.hint-first-time-1'|translate"></span>&nbsp;<wbr/>
            <span [innerHtml]="'poll.hint-first-time-2-before-wap'|translate"></span><wbr/><span (click)="glossary('wap')" style="cursor: pointer; white-space: nowrap"><span class="externallink" [innerHtml]="'poll.hint-first-time-2-wap'|translate"></span><ion-icon name="help-circle-outline" style="font-size: 16px; position: relative; top:4px;"></ion-icon></span><span [innerHtml]="'poll.hint-first-time-2-after-wap'|translate"></span>
            <!-- assist link: -->
            &nbsp;<wbr/><span style="white-space: nowrap;">
              (<a 
                (click)="assist_dialog()"
                [innerHtml]="'poll.assist-me-inline' | translate">
              </a>)
            </span>
          </p>
        </small>
      </ion-item>
      <ion-item *ngIf="p.am_abstaining" color="danger">
        <small>
          <p>
            <span style="font-size: medium" [innerHtml]="'poll.hint-abstaining-1'|translate"></span>&nbsp;<wbr/>
            <span [innerHtml]="'poll.hint-abstaining-2-before-wap'|translate"></span><wbr/><span (click)="glossary('wap')" style="cursor: pointer; white-space: nowrap"><span class="externallink" [innerHtml]="'poll.hint-abstaining-2-wap'|translate"></span><ion-icon name="help-circle-outline" style="font-size: 16px; position: relative; top:4px;"></ion-icon></span><span [innerHtml]="'poll.hint-abstaining-2-after-wap'|translate"></span>
            <!-- assist link: -->
            &nbsp;<wbr/><span style="white-space: nowrap;">
              (<a 
                (click)="assist_dialog()"
                [innerHtml]="'poll.assist-me-inline' | translate">
              </a>)
            </span>
          </p>
        </small>
      </ion-item>
      <ion-item *ngIf="p.my_n_rated_positive == 1" color="warning">
        <small>
          <p>
            <span style="font-size: medium" [innerHtml]="'poll.hint-only1positive-1-before-wap'|translate"></span><wbr/><span (click)="glossary('wap')" style="cursor: pointer; white-space: nowrap"><span style="font-size: medium" class="externallink" [innerHtml]="'poll.hint-only1positive-1-wap'|translate"></span><ion-icon name="help-circle-outline" style="font-size: 16px; position: relative; top:3px;"></ion-icon></span><span style="font-size: medium" [innerHtml]="'poll.hint-only1positive-1-after-wap'|translate"></span>&nbsp;<wbr/>
            <span [innerHtml]="'poll.hint-only1positive-2'|translate"></span>
            <!-- assist link: -->
            &nbsp;<wbr/><span style="white-space: nowrap;">
              (<a 
                (click)="assist_dialog()"
                [innerHtml]="'poll.assist-me-inline' | translate">
              </a>)
            </span>
          </p>
        </small>
      </ion-item>
      <ion-item *ngIf="show_live && p.my_n_rated_positive != 1 && p.my_n_approved == 1" color="secondary">
        <small>
          <p>
            <span style="font-size: medium" [innerHtml]="'poll.hint-only1approved-1-before-approving'|translate"></span><wbr/><span (click)="glossary('approve')" style="cursor: pointer; white-space: nowrap"><span style="font-size: medium" class="externallink" [innerHtml]="'poll.hint-only1approved-1-approving'|translate"></span><ion-icon name="help-circle-outline" style="font-size: 16px; position: relative; top:3px;"></ion-icon></span><span style="font-size: medium" [innerHtml]="'poll.hint-only1approved-1-after-approving'|translate"></span>&nbsp;<wbr/>
            <span [innerHtml]="'poll.hint-only1approved-2-before-wap'|translate"></span><wbr/><span (click)="glossary('wap')" style="cursor: pointer; white-space: nowrap"><span class="externallink" [innerHtml]="'poll.hint-only1approved-2-wap'|translate"></span><ion-icon name="help-circle-outline" style="font-size: 16px; position: relative; top:4px;"></ion-icon></span><span [innerHtml]="'poll.hint-only1approved-2-after-wap'|translate"></span>
            <!-- assist link: -->
            &nbsp;<wbr/><span style="white-space: nowrap;">
              (<a 
                (click)="assist_dialog()"
                [innerHtml]="'poll.assist-me-inline' | translate">
              </a>)
            </span>
          </p>
        </small>
      </ion-item>
      <ion-item *ngIf="show_live && p.my_n_approved > 1 && !p.T.approvals_map.get(oidsorted[0]).get(p.myvid)" color="light">
        <small>
          <p>
            <span [innerHtml]="'poll.hint-mostapproved-1'|translate"></span>
          </p>
        </small>
      </ion-item>
      
    </ng-container>

    <!-- FINAL RESULTS (if ended and results are ready): -->

    <!-- winner exists: -->
    <ng-container *ngIf="p.has_results && p.type=='winner'">
      <ion-item color="light">
        <p [innerHtml]="'poll.results'|translate">
        </p>
      </ion-item>
      <ion-item color="danger">
        <h3>
          <b [innerHtml]="'poll.winner-is'|translate:{winner:p.options[p.winner].name}"></b>
        </h3>
      </ion-item>
      <ion-item color="warning">
        <p>
          <b [innerHtml]="'poll.reason'|translate"></b>&nbsp;
          <span 
            *ngIf="p.T.n_not_abstaining == 0" 
            [innerHtml]="'poll.reason-all-abstained'|translate:{}"></span>
          <span 
            *ngIf="p.T.n_not_abstaining > 0 && p.T.approval_scores_map.get(oidsorted[0]) == p.T.n_not_abstaining && p.T.approval_scores_map.get(oidsorted[1]) < p.T.n_not_abstaining" 
            [innerHtml]="'poll.reason-full-consensus-unique'|translate:{}"></span>
          <span 
            *ngIf="p.T.n_not_abstaining > 0 && p.T.approval_scores_map.get(oidsorted[0]) == p.T.n_not_abstaining && p.T.approval_scores_map.get(oidsorted[1]) == p.T.n_not_abstaining" 
            [innerHtml]="'poll.reason-full-consensus-highest'|translate:{}"></span>
          <span 
            *ngIf="p.T.n_not_abstaining > 0 && p.T.approval_scores_map.get(oidsorted[0]) < p.T.n_not_abstaining && p.winner == oidsorted[0]" 
            [innerHtml]="'poll.reason-largest-approval'|translate:{
              approval:(p.T.approval_scores_map.get(oidsorted[0])/p.T.n_not_abstaining*100).toFixed(1),
              disapproval:(100-p.T.approval_scores_map.get(oidsorted[0])/p.T.n_not_abstaining*100).toFixed(1)}"></span>
          <span 
            *ngIf="p.T.n_not_abstaining > 0 && p.T.approval_scores_map.get(oidsorted[0]) < p.T.n_not_abstaining && p.winner != oidsorted[0]" 
            [innerHtml]="'poll.reason-smaller-approval'|translate:{
              share:(p.T.shares_map.get(p.winner)*100).toFixed(1)}"></span>
        </p>
      </ion-item>
    </ng-container>

    <!-- shares exist: -->
    <ng-container *ngIf="p.has_results && p.type=='share'">
      <ion-item color="light">
        <p [innerHtml]="'poll.results'|translate">
        </p>
      </ion-item>
      <ion-item color="danger">
        <ion-text>
          <ng-container *ngFor="let item of [].constructor(oidsorted.length); let i = index">
            <ng-container *ngIf="p.T.shares_map.get(oidsorted[i]) > 0">
                <h3><b>
                  <span [innerHtml]="'poll.of-the-budget-go-to'|translate:{share:(p.T.shares_map.get(oidsorted[i])*100).toFixed(1), option:p.options[oidsorted[i]].name}"></span>
                </b></h3> 
            </ng-container>
          </ng-container>
        </ion-text>   
      </ion-item>
    </ng-container>

    <!-- results not ready yet: -->
    <ng-container *ngIf="!p.allow_voting && !p.has_results">
      <ion-item color="warning">
        <p [innerHtml]="'poll.wait-for-results'|translate">
        </p>
      </ion-item>
    </ng-container>

    <!-- FINAL WAPS EXPANDER (if ended): -->

    <ion-item *ngIf="!p.allow_voting" 
        color="light"
        (click)="final_expanded=!final_expanded"
        style="cursor: pointer;">
      <ion-icon 
        [name]="final_expanded?'caret-down-outline':'caret-forward-outline'" 
        size="small" color="primary">
      </ion-icon>&nbsp;&nbsp;<ion-label>
        <span [innerHtml]="'poll.final-ratings'|translate"></span>
      </ion-label>
    </ion-item>
    
    <!-- POTENTIALLY HIDDEN CONTENT: -->

    <div [style.display]="p.allow_voting || final_expanded ? 'block' : 'none'">

      <!-- INCOMING DELEGATIONS BANNER: -->

      <ion-item *ngIf="(accepted_requests.length > 0) || (declined_requests.length > 0)"
          color="light">
        <ion-grid class="ion-no-padding ion-no-margin">

          <!-- SUMMARY: -->

          <ion-row 
              class="ion-no-padding ion-no-margin" 
              style="padding-top: 5px; padding-bottom: 6px; cursor: pointer;"
              (click)="incoming_delegation_expanded =! incoming_delegation_expanded">
            <ion-col class="ion-no-margin ion-padding-right" >
              <small>
                <ion-icon 
                  [name]="(incoming_delegation_expanded) ? 'chevron-down-outline' : 'chevron-forward-outline'" 
                  size="smaller" class="ion-no-margin" 
                  style="color:black; position: relative; left: -2px; top: 2px;">
                </ion-icon>
                <span *ngIf="accepted_requests.length > 0" 
                  [innerHtml]="
                    ((n_indirect_clients == 1 ? 'poll.also-for-other' : 'poll.also-for-others' )
                    | translate: {n_others: n_indirect_clients})
                    + ' '
                  ">
                </span>
                <span *ngIf="declined_requests.length > 0" 
                  [innerHtml]="(n_indirect_clients == 0 ? 'poll.declined-all' : 'poll.declined-some') | translate">
                </span>
                &nbsp;
              </small>
            </ion-col>
          </ion-row>

          <!-- EXPANDABLE DETAILS: -->

          <!-- Accepted requests: -->

          <ion-row *ngIf="incoming_delegation_expanded && accepted_requests.length > 0">
            <ion-col class="ion-text-right">
              <small>
                <span [innerHtml]="'poll.have-accepted' | translate"></span>
                <ion-chip *ngFor="let r of accepted_requests" 
                    [routerLink]="r.url" 
                    outline="true">
                  <ion-icon 
                    name="mail-open-outline"
                    style="color:grey" size="small">
                  </ion-icon>
                  <small>{{r.from}}</small>
                </ion-chip>
              </small>
            </ion-col>
          </ion-row>

          <!-- Declined requests: -->

          <ion-row *ngIf="incoming_delegation_expanded && declined_requests.length > 0">
            <ion-col class="ion-text-right">
              <small>
                <span [innerHtml]="'poll.have-declined' | translate"></span>
                <ion-chip *ngFor="let r of declined_requests" 
                    [routerLink]="r.url" 
                    outline="true">
                  <ion-icon 
                    name="mail-open-outline"
                    style="color:grey" size="small">
                  </ion-icon>
                  <small>{{r.from}}</small>
                </ion-chip>
              </small>
            </ion-col>
          </ion-row>

        </ion-grid>
      </ion-item>

      <!-- OUTGOING DELEGATION BANNER: -->

      <ion-item *ngIf="delegation_status=='pending'" 
          color="warning"> 
        <ion-grid class="ion-no-padding ion-no-margin">
          <ion-row class="ion-no-padding ion-no-margin ion-align-items-center">

            <ion-col class="ion-no-margin ion-padding-right">
              <small>
                <p>
                  <span style="font-size: medium;">{{delegate}}</span>&nbsp;
                  <span [innerHtml]="
                    'poll.delegate-not-responded' | translate
                    ">
                  </span>
                </p>
              </small>
            </ion-col>

            <!-- Revoke delegation button: -->

            <ion-col size="auto" class="ion-no-margin">
              <ion-button 
                  [disabled]="!p.allow_voting"
                  fill="clear" (click)="revoke_delegation_dialog()">
                <ion-icon name="trash-outline" style="color:black"></ion-icon>
              </ion-button>
            </ion-col>

          </ion-row>
        </ion-grid>
      </ion-item>

      <ion-item *ngIf="delegation_status=='agreed'" 
          color="warning"> 
        <ion-grid class="ion-no-padding ion-no-margin">
          <ion-row class="ion-no-padding ion-no-margin ion-align-items-center">

            <!-- TODO: if on cycle, warn that own rating still matters, and show cycle len! 
              - if toggle is off, dashed additional needle should show the rating 
                that would result if toggle were on, i.e., the max of own and rest of cycle
              - if toggle is on, the slider still needs to be active since proxy rating still depends on own!
                the slider will then be own rating. 
                if value >= max on rest of cycle, it will look normal, and max on rest will be shown as an additional mark (a dashed small circle?).
                if value < max on rest of cycle, it will be normal size but grey, and max on cycle will be shown as colored but small solid needle protruding from behind it.
                details text will explain about this!
            -->

            <!-- Info about how many of user's ratings the delegate controls: -->

            <ion-col class="ion-no-margin ion-padding-right">
              <small>
                <p>
                  <span style="font-size: medium;">{{delegate}}</span>&nbsp;
                  <span [innerHtml]="
                    'poll.delegate-controls-' 
                    + (n_delegated == oidsorted.length ? 'all' 
                      : 2*n_delegated > oidsorted.length ? 'most' 
                      : n_delegated > 0 ? 'some' : 'none'
                      ) | translate
                    ">
                  </span>
                </p>
              </small>
            </ion-col>

            <!-- Revoke delegation button: -->

            <ion-col size="auto" class="ion-no-margin">
              <ion-button fill="clear" (click)="revoke_delegation_dialog()">
                <ion-icon name="trash-outline" style="color:black"></ion-icon>
              </ion-button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </ion-col>

            <!-- Help text for delegation toggles: -->

            <ion-col 
                size="auto" 
                class="ion-no-padding ion-no-margin ion-padding-left ion-text-right" 
                style="padding-bottom:3px;">
              <small>
                <p>
                  <span [innerHtml]="'poll.choose-whose-ratings' | translate"></span>&nbsp;
                  <ion-icon 
                    name="arrow-down-outline" 
                    style="position:relative;top:3px;">
                  </ion-icon>
                </p>
              </small>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-item>

      <!-- TABLE HEADER: -->

      <ion-item class="ion-no-padding ion-no-margin" lines="none"
            style="--min-height: 0px!important; font-weight: bold;">
        <small (click)="(show_live||!p.allow_voting)?glossary('share'):null" style="padding-top: 8px!important;padding-left: 6px; width: 68px!important; color: #769596; text-align: center;">
          <span *ngIf="show_live||!p.allow_voting" style="width: 100%!important" class="externallink" [innerHtml]="'share'|translate"></span>
        </small>
        <small (click)="glossary('wap')" style="padding-left: 6px!important; padding-top: 8px!important; flex-grow: 1; color: #769596;"><!--#62a73b;-->
          <span class="externallink" [innerHtml]="'poll.your-wap'|translate"></span><!-- &rarr;-->
        </small>
        <!-- TODO: make padding robustly correct accross devices: -->
        <small (click)="(show_live||!p.allow_voting)?glossary('approve'):null" [style]="'padding-top: 8px!important; padding-right: '+(delegation_status=='agreed'?62:10)+'px; color: #769596;'"><!--#9abcbd--><!--&larr; -->
          <ng-container *ngIf="show_live||!p.allow_voting">
            <ion-icon name="caret-down" style="position: relative; top: 2px;"></ion-icon>&nbsp;<span class="externallink" [innerHtml]="'approval'|translate"></span>
          </ng-container>
        </small>
      </ion-item>

      <!-- OPTIONS: -->

      <ion-item *ngFor="let item of [].constructor(oidsorted.length); let i = index" style="align-items:flex-start">

        <!-- ALWAYS VISIBLE STUFF: -->

        <ion-grid class="ion-no-padding ion-no-margin">

          <ion-row class="ion-no-padding ion-no-margin">

            <!-- PIE CHART WITH WINNING PROBABILITY: -->

            <ion-col size="auto" class="ion-no-padding ion-no-margin">
              <div style="width: 60px!important"></div>
              <svg [attr.display]="(show_live||!p.allow_voting)?'inline':'none'" xmlns="http://www.w3.org/2000/svg" width="60px" height="60px" style="position:absolute; bottom:0px;"><!--top:12px;-->
                <circle cx="21" cy="25" r="20" fill="#bce4e5" stroke="none" />
                <path [id]="'pie_'+oidsorted[i]" d="M 21,25 l 0,-20 a 20 20 0 0 1 0 0 Z" fill="#9abcbd" />
                <line [attr.display]="option_expanded[oidsorted[i]] ? 'inline' : 'none'"
                  x1="21" y1="48" x2="21" y2="60" stroke="#769596" stroke-width="1" stroke-dasharray="1 1"></line>
              </svg>
            </ion-col>

            <ion-col>

              <ion-grid class="ion-no-padding ion-no-margin">

                <ion-row class="ion-no-padding ion-no-margin" style="padding-top: 8px; cursor: pointer; position: relative; left: -6px; z-index:20; "
                    (click)="expand(oidsorted[i])">
                  <ion-col class="ion-no-padding ion-no-margin">

                    <ion-input style="display: none;"></ion-input><!--this is needed so that the following ion-label is not greyed out when the ion-range below is disabled!-->
                    <ion-label class="ion-no-padding ion-no-margin" style="max-width: 100%!important;">
    
                      <ion-icon 
                        [name]="(option_expanded[oidsorted[i]]) ? 'chevron-down-outline' : 'chevron-forward-outline'" 
                        size="small" class="ion-no-margin" 
                        style="color:black; position: relative; top: 3px;">
                      </ion-icon>

                      <!-- OPTION NAME: -->
    
                      <b><i>&nbsp;<span [lang]="p.language" [innerHtml]="p.options[oidsorted[i]].name"></span>&nbsp;</i></b>
                    </ion-label>
    
                  </ion-col>
                </ion-row>

                <!-- RATING CONTROLS: -->

                <ion-row class="ion-no-padding ion-no-margin">

                  <ion-col 
                      [id]="'_slider_'+oidsorted[i]+'_'+sortingcounter"
                      class="ion-no-padding ion-no-margin" 
                      (click)="onRatingColClick(oidsorted[i], $event)" 
                      (pointerdown)="onRatingColPointerdown(oidsorted[i], $event)" 
                      (touchstart)="onRatingColTouchstart(oidsorted[i], $event)" 
                      (touchup)="onRatingColTouchup(oidsorted[i], $event)"
                      (pointerup)="onRatingColPointerup(oidsorted[i], $event)"
                      >

                    <!-- SLIDER: -->

                    <!-- TODO: sometimes looks strange in Chrome (white shadowed large knob, bar displaced too low)-->
                    <ion-range 
                        [disabled]="!p.allow_voting"
                        [id]="'slider_'+oidsorted[i]+'_'+sortingcounter" 
                        [color]="show_live?slidercolor[oidsorted[i]]:'vodleblue'"
                        [value]="p.get_my_proxy_rating(oidsorted[i])" 
                        (ionFocus)="onRatingSliderFocus(oidsorted[i])" 
                        (ionChange)="onRatingSliderChange(oidsorted[i])" 
                        (ionBlur)="onRatingSliderBlur(oidsorted[i])"
                        mode="md" pin="true"
                        min="0" max="100" step="1" snaps="true" ticks="false"
                        [style]="''
                          + (rate_yourself_toggle[oidsorted[i]] || delegation_status!='agreed'
                          ? 'pointer-events:; --bar-height: 7px; --knob-size: 35px'
                          : 'pointer-events: none; --bar-height: 5px; --knob-size: 17px')" 
                        class="ion-no-padding ion-no-margin">

                      <ion-label 
                          slot="end" 
                          class="ion-no-padding ion-no-margin" 
                          style="margin-right:12px;">
                          <!--don't do width:100% in ion-label since otherwise the slider is not working properly!-->

                        <!-- APPROVAL BAR: -->

                        <div style="position: absolute; bottom: 0px; right: 11px; z-index: -10; width: 100%; padding-left: 11px">
                          <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="35px">
                            <rect [id]="'bar_' + oidsorted[i]"
                              [attr.display]="(show_live||!p.allow_voting)?'inline':'none'" 
                              x="100%" width="0%" y="8" height="18" 
                              fill="#bce4e5" stroke="none" /><!--Note: width will change dynamically-->
                            <line [attr.display]="(show_live||!p.allow_voting)?'inline':'none'" 
                              x1="100%" y1="0" x2="100%" y2="34" fill="none" stroke="#bce4e5" stroke-width="5" 
                              />
                            <line x1="0%" x2="100%" y1="17" y2="17" stroke="#b4dbdb" stroke-width="2" stroke-dasharray="2 2" />
                            <!--<rect x="0%" width="100%" y="16" height="2" fill="#b4dbdb" stroke="none" />-->
                          </svg>
                        </div>

                        <!-- Numerical annotations when expanded: -->

                        <div style="position: absolute; bottom: 0px; right: 11px; z-index: 10; width: 100%; padding-left: 11px; pointer-events: none;">
                          <svg [attr.display]="((show_live||!p.allow_voting) && option_expanded[oidsorted[i]]) ? 'inline' : 'none'" 
                              xmlns="http://www.w3.org/2000/svg" width="100%" height="45px">
                            <!--
                            <text x="0%" y="20" 
                              style="font-weight: bold; font-size: 12px;" fill="slidercolor[oidsorted[i]]" 
                              [innerHtml]="p.get_my_proxy_rating(oidsorted[i])">
                            </text>
                            -->
                            <text x="100%" y="15" 
                              style="font-weight: bold; font-size: 12px;" text-anchor="end" fill="#9abcbd" [innerHtml]="
                                (p.T.approval_scores_map.get(oidsorted[i]) / Math.max(1, p.T.n_not_abstaining) * 100).toFixed(1) + '%&nbsp;&nbsp;'
                              ">
                            </text>
                          </svg>
                        </div>

                        <!-- DELEGATE'S RATING -->

                        <div style="position: absolute; top: -2px; right: 11px; z-index: -5; width: 100%; padding-left: 11px"
                            [style.display]="delegation_status=='agreed' && rate_yourself_toggle[oidsorted[i]] ? 'inline' : 'none'">
                          <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="15px">
                            <line [id]="'del_needle_' + oidsorted[i]" x1="0" y1="8" x2="50%" y2="8" fill="none" stroke="#9abcbd" stroke-width="2" stroke-dasharray="3 2" />
                            <circle [id]="'del_knob_' + oidsorted[i]" cx="50%" cy="8" r="5" fill="#9abcbd" stroke="none"/>
                            <!--FIXME: circle is cropped when close to either endpoint. how to avoid this?-->
                          </svg>
                        </div>

                      </ion-label>
                    </ion-range>
                  </ion-col>

                  <!-- DELEGATION TOGGLE: -->

                  <ion-col *ngIf="delegation_status=='agreed'" 
                      class="ion-no-margin ion-no-padding" 
                      size="auto">&nbsp;&nbsp;&nbsp;
                    <ion-toggle [id]="'rate_yourself_toggle_' + oidsorted[i]" 
                      [disabled]="!p.allow_voting"
                      (ionChange)="on_rate_yourself_toggle_change(oidsorted[i])"
                      class="ion-no-margin ion-no-padding ion-padding-bottom ion-padding-top" 
                      style="position:relative; top:-8px;" 
                      [(ngModel)]="rate_yourself_toggle[oidsorted[i]]">
                    </ion-toggle>
                    <div style="position:absolute; z-index:10; top:22px; right:1px; text-align:right;">
                      <small [innerHtml]="
                        rate_yourself_toggle[oidsorted[i]] 
                        ? ('poll.my-own' | translate) 
                        : ('poll.delegate-s' | translate: {delegate: delegate})
                        " >
                      </small>
                    </div>
                  </ion-col>  
                </ion-row>
              </ion-grid>
            </ion-col>
          </ion-row>
          <ion-row class="ion-no-padding ion-no-margin">
            <ion-col class="ion-no-padding ion-no-margin">
              <ion-grid class="ion-no-padding ion-no-margin">

                <!-- EXPANDABLE OPTION DETAILS -->

                <!-- TODO: replace by simpler container: -->
                <app-expandable [id]="'expander_'+oidsorted[i]+'_'+sortingcounter" 
                    [expanded]="option_expanded[oidsorted[i]]">
                  <ion-row class="ion-no-padding ion-padding-bottom ion-no-margin">
                    <ion-col class="ion-no-padding ion-no-margin">

                      <!-- Live results: -->

                      <b [style.display]="(show_live||!p.allow_voting)?'inline':'none'">
                        <!-- Winning chance/budget share: -->
                        <span style="color:#769596;">
                          <span style="white-space: nowrap;" [innerHtml]="
                            (p.type == 'winner' 
                                ? (p.allow_voting?'poll.chance-to-win':'poll.final-chance-to-win') 
                                : (p.allow_voting?'poll.of-the-budget':'poll.final-budget')) 
                            | translate: {percentage: 
                              (p.T.shares_map.get(oidsorted[i]) * 100).toFixed(1)
                            }">
                          </span><small><wbr> <span style="color:#4c822e;" 
                              [style.display]="(votedfor == oidsorted[i]) ? 'inline' : 'none'"
                              [innerHtml]="'poll.including-your-share' | translate">
                            </span>,
                          </small>
                        </span><small><wbr> </small>
                        <!-- Approval: -->
                        <span style="color:#9abcbd; white-space: nowrap;">
                          <span [innerHtml]="
                            'poll.approved-by' | translate: {percentage:
                              (p.T.approval_scores_map.get(oidsorted[i]) / Math.max(1, p.T.n_not_abstaining) * 100).toFixed(1)
                            }">
                          </span>
                        </span>
                        <small>
                          <span style="color:#62a73b" 
                            [style.display]="approved[oidsorted[i]] ? 'inline' : 'none'"
                            [innerHtml]="'poll.including-you' | translate">
                          </span>
                        </small>
                        <small>
                          <!-- avg. rating: -->
                          <span *ngIf="(i>0 
                                    && p.T.approval_scores_map.get(oidsorted[i-1]) 
                                    == p.T.approval_scores_map.get(oidsorted[i])) 
                                || (i<oidsorted.length-1 
                                    && p.T.approval_scores_map.get(oidsorted[i+1]) 
                                    == p.T.approval_scores_map.get(oidsorted[i]))" 
                                style="color:#9abcbd">,
                            <span style="white-space: nowrap;" [innerHtml]="
                              'poll.average-rating' | translate: {average:
                                (p.T.total_effective_ratings_map.get(oidsorted[i]) / Math.max(1, p.T.n_not_abstaining)).toFixed(1)
                              }">
                            </span>
                          </span>&nbsp;
                          <!-- explanation link: -->
                          <span style="color:#9abcbd; white-space: nowrap;">
                            (<a 
                              (click)="explain_approval_dialog(oidsorted[i])"
                              [innerHtml]="'poll.explain' | translate">
                            </a>)
                          </span>
                        </small>
                      </b>

                      <!-- Description: -->
                      
                      <span [style.display]="((show_live||!p.allow_voting) && (!!p.options[oidsorted[i]].desc || !!p.options[oidsorted[i]].url)) ? 'inline' : 'none'">
                        <br/>
                      </span>
                      <span [style.display]="p.options[oidsorted[i]].desc != '' ? 'inline' : 'none'">
                        <i><span [lang]="p.language" [innerHtml]="p.options[oidsorted[i]].desc"></span>&nbsp;&nbsp;</i>
                      </span>
                      <span [style.display]="p.options[oidsorted[i]].url != '' ? 'inline' : 'none'">
                        <small>
                          (<span (click)="G.open_url_in_new_tab(G.D.fix_url(p.options[oidsorted[i]].url))"><ion-text 
                              class="externallink"  
                              [innerHtml]="'read-more' | translate">
                          </ion-text>&nbsp;<ion-icon name="open-outline" style="position: relative; top: 2px;"></ion-icon></span>)
                        </small>
                      </span>

                      <!-- debugging info: - ->

                      <small>
                        <br/>direct_delegation_map: {{G.map2str(p.direct_delegation_map.get(oidsorted[i]))}}
                        <br/>inv_direct_delegation_map: {{G.map2str(p.inv_direct_delegation_map.get(oidsorted[i]))}}
                        <br/>indirect_delegation_map: {{G.map2str(p.indirect_delegation_map.get(oidsorted[i]))}}
                        <br/>inv_indirect_delegation_map: {{G.map2str(p.inv_indirect_delegation_map.get(oidsorted[i]))}}
                        <br/>effective_delegation_map: {{G.map2str(p.effective_delegation_map.get(oidsorted[i]))}}
                        <br/>inv_effective_delegation_map: {{G.map2str(p.inv_effective_delegation_map.get(oidsorted[i]))}}
                        <br/>ratings_ascending_map: {{G.map2str(p.T.ratings_ascending_map)}}
                        <br/>thresholds_map: {{G.map2str(p.T.thresholds_map)}}
                        <br/>approval_scores_map: {{G.map2str(p.T.approval_scores_map)}}
                        <br/>total_effective_ratings_map: {{G.map2str(p.T.total_effective_ratings_map)}}
                        <br/>votes_map: {{G.map2str(p.T.votes_map)}}
                        <br/>n_votes_map: {{G.map2str(p.T.n_votes_map)}}
                        <br/>shares_map: {{G.map2str(p.T.shares_map)}}
                      </small>
                      <!---->
                      
                    </ion-col>
                  </ion-row>
                </app-expandable>
              </ion-grid>
            </ion-col>
          </ion-row>
        </ion-grid>

      </ion-item>

      <!-- ADD OPTION BUTTON: -->

      <ng-container *ngIf="p.allow_voting">
        <ion-item lines="none" class="ion-no-padding" style="padding-left: 10px; padding-top: 10px;">
          <ion-fab-button 
            size="small" (click)="add_option($event)" fill="clear" color="primary">
            <ion-icon name="add"></ion-icon>
          </ion-fab-button>
          <ion-button 
            class="ion-no-padding ion-no-margin" fill="clear" (click)="add_option($event)"
            [innerHtml]="'poll.add-option' | translate"> 
          </ion-button>
        </ion-item>
        <ion-item lines="none" style="padding-bottom: 10px!important;">
          <small [innerHtml]="'poll.add-option-info' | translate"></small>
        </ion-item>
      </ng-container>

    </div>

    <!-- DEBUGGING AREA (not in production mode): -->

    <ng-container *ngIf="E.show_debug_info">
      <ion-item></ion-item>
      <ion-item class="ion-text-right" lines="none">
        <ion-col><small><p style="color: grey;">
          Debugging info: cycle_len={{p.T.my_cycle_len}}, state={{p.state}}, vid={{p.myvid}}, oids={{p.oids}}, oidsorted={{oidsorted}}/{{p.T.oids_descending}}, scores_map={{G.map2str(p.T.scores_map)}}. 
          Simulate state (off:closed, on:running): 
        </p></small></ion-col>
        <ion-buttons slot="end">
          <!-- only in debug: simulate closing -->
          <ion-toggle color="light"
            [(ngModel)]="p.allow_voting">
          </ion-toggle>
        </ion-buttons>
      </ion-item>
    </ng-container>

  </ion-list>

  <ion-item *ngIf="p.state == 'closed'">
    <ion-checkbox slot="start" [(ngModel)]="p.is_archived" ></ion-checkbox><ion-label [innerHtml]="'poll.archive'|translate"></ion-label>
  </ion-item>
</ion-content>


<!-- OPTIONAL GLOSSARY: -->

<ion-footer *ngIf="show_glossary" style="box-shadow: 0px -3px 4px #eeeeee;">
  <ion-item color="light">
    <ion-text>
    <ion-button (click)="dismiss_glossary()" fill="clear" class="ion-float-right ion-margin-right ion-margin-left ion-no-padding"
        style="position: relative; right: -6px; top: 3px;">
      <ion-icon class="ion-no-margin ion-no-padding" slot="icon-only" name="close" color="primary"></ion-icon>
    </ion-button>
    <small [innerHtml]="'glossary.'+glossary_key|translate"></small>
  </ion-text>
  </ion-item>
</ion-footer>

